# 10장

## 1단계 문제 이해 및 설계 범위 확정

#### 알림의 종류?

- 푸시 알림, SMS 메시지, 이메일

#### 실시간 시스템 여부

- 연성 실시간 시스템

#### 지원 단말

- iOS 단말, 안드로이드 단말, 랩톱/데스크톱

#### 알림 생성주체

- 클라이언트 App, 서버

#### 알림 거부 설정

- 사용자가 설정

#### 일일 건수

- 1000만건의 모바일 푸시 알림, 100만건의 SMS 메시지, 500만건의 이메일

## 2단계 개략적 설계안 제시 및 동의 구하기

각 시스템 별 개략적 설계안은 다음과 같다. 기본적으로는 다음과 같은 내용을 다룬다.

- 알림 유형별 지원 방안
- 연락처 정보 수집 절차
- 알림 전송 및 수신 절차

### 알림 유형별 지원 방안

#### iOS 푸시 알림

ios 푸시 알림을 보내기 위해서는 세 가지 컴포넌트가 필요하다.

![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252F79841688-7901-4d03-9fbf-7e99db7b90d0%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-2.png%3Ftable%3Dblock%26id%3D63b554f8-3f53-42fc-bf27-c149cb529e4b%26cache%3Dv2&w=2048&q=75)

- 알림 제공자(Provider): 알림 요청을 만들어, 애플 푸시 알림 서비스로 보내는 주체다. 알림 요청을 보내기 위해서는 다음과 같은 데이터가 필요하다.
  - 단말 토큰 : 알림 요청을 보내기 위한 고유 식별자
  - 페이로드 : 알림 내용을 담은 JSON Dictionary
  - APNS : 애플이 제공하는 원격 서비스로, 푸시 알림을 기기로 보내는 역할을 담당한다.
  - iOS 단말 : 푸시 알림을 수신하는 사용자 단말

#### 안드로이드 푸시 알림

안드로이드 푸시 알람도 비슷하다. APNS 대신 FCM을 사용한다는 점만 다르다.

![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252F45e88611-24f9-4688-adbf-564e6c09095e%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-3.png%3Ftable%3Dblock%26id%3Df2a38184-a5df-444d-a747-a2b44e676c66%26cache%3Dv2&w=2048&q=75)

#### SMS 메세지

SMS 메세지는 보통 트윌리오, 넥스모 같은 제3자 서비스를 이용한다.

![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252Fa0a6ce5d-2cad-47cc-a57a-37dbfdb2a4b2%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-4.png%3Ftable%3Dblock%26id%3D7e731b66-8d4a-4084-9532-50005989d82e%26cache%3Dv2&w=2048&q=75)

#### 이메일

대부분의 회사는 고유 이메일 서버를 구축할 역량은 갖추고 있다. 그럼에도 많은 회사가 상용 이메일 서비스를 이용한다. 유명한 서비스로는 샌드그리드, 메일침프가 있다.

![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252F57a2e93c-13ee-4ddb-80a8-9a36d773a689%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-5.png%3Ftable%3Dblock%26id%3D250dc61d-264e-4756-b557-21ca8d377753%26cache%3Dv2&w=2048&q=75)

#### 연락처 정보 수집 절차

알림 전송을 위해서는 단말 토큰, 전화번호, 이메일 주소 등 개인 정보 수집 절차가 필요하다.

### 알림 전송 및 수신 절차

#### 개략적 설계안(초안)

![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252F0fe4b55c-95b4-4dda-a0b6-93aad792aa01%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-9.png%3Ftable%3Dblock%26id%3D538652dd-87de-4e86-9c97-43a2a866f7d3%26cache%3Dv2&w=2048&q=75)

- 1부터 N까지의 서비스 : 마이크로서비스일 수도 있고, 크론 잡일수도 있고 시스템 분산 컴포넌트일 수도 있다.
- 알림 시스템 : 알림 전송/수신 처리의 핵심이다. 우선은 1개 서버만 사용하는 시스템이라고 가정해보면, 각 서버에 알림 전송을 위한 API와 제3자 서비스에 전달할 페이로드를 생성할 수 있어야 한다.
- 제3자 서비스 : 사용자에게 실제로 알림을 전달하는 역할을 한다. 제3자 서비스와의 통합을 진행할 때 유의할 점은 확장성이다. 쉽게 새 서비스를 통합하거나, 기존 서비스를 제거할 수 있어야 한다. 그리고 특정 서비스를 사용할 수 없는 시장도 존재하는 것을 고려해야 한다. FCM은 중국에서 사용할 수 없어 Jpush같은 서비스를 사용해야 한다.
- iOS, 안드로이드, SMS, 이메일 단말: 사용자는 자기 단말에서 알림을 수신한다.

이 설계에는 몇 가지 문제가 있다.

- SPOF: 알림 서비스 컴포넌트가 위는 하나밖에 없는데 알림 서비스의 장애가 모든 장애로 이어지는 것이다.
- 규모 확장성: 한 대의 서비스로 푸시 알림에 관계된 모든 것을 처리하므로 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 늘리기 어렵다.
- 성능 병목: 알림을 처리하고 보내는 것은 자원이 많이 필요한 작업일 수 있다. 한 번에 많은 처리를 하면 시스템이 과부하 상태에 걸릴 수 있다.

#### 개략적 설계안 (개선된 버전)

- 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리한다.
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다.
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.

![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252F0aa9f952-3d65-4e87-8107-994d139c5207%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-10.png%3Ftable%3Dblock%26id%3D64b05f43-fc31-4cea-acec-b255eefcb96d%26cache%3Dv2&w=2048&q=75)

- 1부터 N까지의 서비스 : 알림 시스템 서버의 API를 통해 알림을 보낼 서비스들

- 알림 서버 : 다음 기능을 제공한다.
  - 알림 전송 API : 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용 가능하다.
  - 알림 건증 : 이메일 주소, 전화번호 등에 대한 기본적 검증을 수행한다.
  - 데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터를 가져오는 기능이다.
  - 알림 전송 : 알림 데이터를 메시지 큐에 넣는다. 본 설계안의 경우 하나 이상의 메시지 큐를 사용하므로 알림을 병렬적으로 처리할 수 있다.
- 캐시 : 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다.
- 데이터베이스 : 사용자, 알림, 설정 등 다양한 정보를 저장한다.
- 메시지 큐 : 시스템 컴포넌트 간 의존성을 제거하기 위해 사용한다. 다량의 알림이 전송되어야 하는 경우를 대비한 버퍼 역할도 한다. 본 설계안에서는 알림의 종류별로 별도 메시지 큐를 사용하였다. 따라서 제 3자 서비스 가운데 하나에 장애가 발생해도 다른 종류의 알림은 정상 동작하게 된다.
- 작업 서버 : 메시지 큐에서 전송할 알림을 꺼내서 제 3자 서비스로 전달하는 역할을 하는 서버다.
- 제 3자 서비스
- iOS, 안드로이드, SMS, 이메일 단말

## 3단계 상세 설계

알림의 종류, 연락처 정보 수집 절차, 그리고 알림 전송/수신 절차에 대해서 살펴보았다. 이제 다음 내용을 좀 더 자세히 알아볼 것이다.

- 안정성
- 추가로 필요한 컴포넌트 및 고려사항
- 개선된 설계안

### 안정성

분산 환경에서 운영될 알림 시스템을 설계할 때는 안정성을 확보하기 위한 사항 몇 가지를 반드시 고려해야 한다.

#### 데이터 손실 방지

알림이 지연되거나 순서가 틀려도 괜찮지만, 소실되면 곤란하다. 따라서 알림을 DB에 보관하고 재시도 메커니즘을 구현해야 한다.

#### 알림 중복 전송 방지

알림이 가끔은 중복 전송되기도 하겠지만 그 빈도를 줄여야 한다.

### 추가로 필요한 컴포넌트 및 고려사항

지금까지 사용자 연락처 정보를 어떻게 수집하고, 알림을 어떻게 보내고 받을것인지 살펴보았다. 그러나 알림 시스템은 사실 이보다 훨씬 복잡하다.

#### 알림 템플릿

대형 알림 시스템은 하루에도 형식이 비슷한 수백만건의 알림을 처리하는데, 알림 템플릿을 이용해 메시지의 모든 부분을 처음부터 다시 만들 필요가 없게 해준다.

#### 알림 설정

사용자가 알림 관련 설정을 할 수 있어야 한다.

#### 전송률 제한

한 사용자가 받을 수 있는 알림 빈도를 제한하는 식으로 특정 사용자에게 너무 많은 알림이 가지 않게 조절한다.

#### 재시도 방법

제3자 서비스가 알림 발송에 실패하면, 알림을 재시도 전용 큐에 넣고 계속해서 같은 문제가 발생하면 서드파티 제공 사에 문의한다.

#### 푸시 알림과 보안

iOS와 안드로이드의 경우 appKey나 appSecret을 통해 전송을 가능하게 하여 보안을 지킨다.

#### 큐 모니터링

큐의 메트릭 정보를 수집하여 작업 서버의 현황을 파악해 적절한 조치를 취하는 것이 좋다.

#### 이벤트 추적

알림 확인율 / 클릭율 / 실제 앱 사용으로 이어지는 비율 같은 메트릭을 취합해 데이터를 분석하여 적절하게 알림 시스템을 수정할 수 있어야 한다.

### 수정된 설계안

![](https://inblog.ai/_next/image?url=https%3A%2F%2Fwww.notion.so%2Fimage%2Fhttps%253A%252F%252Fprod-files-secure.s3.us-west-2.amazonaws.com%252Ff02ca0c9-9279-4cd3-bf61-49a4adc12473%252Fe37b49bd-d2d3-4a5a-a0ce-1cdecf1d31ac%252F%2525E1%252584%252580%2525E1%252585%2525B3%2525E1%252584%252585%2525E1%252585%2525B5%2525E1%252586%2525B710-14.png%3Ftable%3Dblock%26id%3D256044e2-d19e-4329-9cfa-4b20819ce551%26cache%3Dv2&w=2048&q=75)

종전 설계안에 없던 많은 컴포넌트가 추가된 것을 확인할 수 있다.

- 알림 서버에 인증과 전송률 제한 기능이 추가 되었다.
- 전송 실패에 대응하기 위한 재시도 기능이 추가되었다. 전송에 실패한 알림은 다시 큐에 넣고 지정된 횟수만큼 재시도한다.
- 전송 템플릿을 사용하여 알림 생성 과정을 단순화하고 알림 내용의 일관성을 유지한다.
- 모니터링과 추적 시스템을 추가하여 시스템 상태를 확인하고 추후 시스템을 개선하기 쉽도록 하였다.

## 4단계 마무리

- 안정성 : 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 메커니즘을 도입하였다.
- 보안 : 인증된 클라이언트만이 알림을 보낼 수 있도록 appKey, appSecret 등의 메커니즘을 이용하였다.
- 이벤트 추적 및 모니터링 : 알림이 만들어진 후 성공적으로 전송되기까지의 과정을 추적하고 시스템 상태를 모니터링하기 위해 알림 전송의 각 단계마다 이벤트를 추적하고 모니터링할 수 있는 시스템을 통합하였다.
- 사용자 설정 : 사용자가 알림 수신 설정을 조정할 수 있도록 하였다. 따라서 알림을 보내기 전 반드시 해당 설정을 확인하도록 시스템 설계를 변경하였다.
- 전송률 제한 : 사용자에게 알림을 보내는 빈도를 제한할 수 있도록 하였다.
