## 1장

### 단일 서버

![](https://velog.velcdn.com/images/haron/post/53e5053d-37de-4a25-af77-6b8db685d152/image.png)

1. 사용자는 Domain Name을 DNS에 질의해 IP 주소로 변환한다.
2. 해당 IP 주소로 HTTP 요청이 절단된다.
3. 요청을 받은 웹 서버는 HTML 페이지나 JSON 형태의 응답을 반환한다.

- 실제 요청은 Web Application이나 Mobile App에서 온다.

### 데이터베이스

![](https://velog.velcdn.com/images/haron/post/354009d0-6fb1-4ced-8653-3c40ebb0313b/image.png)

- 사용자가 늘어남에 따라 서버를 여러 대 두게 되는데 하나는 Web/Mobile 트래픽 처리 용도로 사용하고 다른 하나는 DB용으로 사용한다.

- DB는 RDBMS와 NoSQL 둘 중 하나를 선택하게 되는데, 아래와 같은 경우에 해당한다면 NoSQL이 좋은 선택이 될 수 있다.
  1. 아주 낮은 응답 지연시간(latency)가 요구됨
  2. 다루는 데이터가 비정형(unstructured)이라 관계형 데이터가 아님
  3. 데이터(JSON, YAML, XML 등)를 직렬화하거나 역직렬화 할 수 있기만 하면 됨
  4. 아주 많은 양의 데이터를 저장할 필요가 있음

### 수직적 규모 확장 vs 수평적 규모 확장

수직적 규모 확장은 사용중인 서버의 CPU나 RAM을 추가하여 성능을 높히는 방식이고 수평적 규모 확장은 사용하는 서버의 대수를 늘리는 방식이다.
수직적 규모 확장은 단일서버의 단점을 그대로 안고 있으므로 보통은 수평적 규모 확장을 주로 실행한다.

#### 로드밸런서

앞서 본 그림에서의 설계로는 웹서버가 다운되면 그대로 서비스가 멈추지만 아래 그림에서처럼 로드밸런서를 통한 수평적 규모 확장이 이루어지면, 일부 웹서버에 문제가 생겨도 로드밸런서가 자동으로 다른 웹서버에 부하를 분배하므로 장애에 대처할 수 있다.
![](https://velog.velcdn.com/images/haron/post/2ad128e8-8a85-4a08-ab8e-f727341efe56/image.png)

#### 데이터베이스 다중화

![](https://velog.velcdn.com/images/haron/post/b898971e-ecfb-4316-bcfd-a30f547ea737/image.png)

웹서버는 여러대로 구성했지만, DB 서버는 아직 1대로 구성되어 있다. DB 서버는 보통 Master - Slave 방식으로 다중화 하는데, 원본을 가지고 있는 Master는 CRUD연산을 전부 수행하지만 사본을 가지고 있는 Slave는 Read연산만을 수행해 아래와 같은 장점을 가진다.

1.  더 나은 성능 : Read 연산의 부하가 Master와 Slave에 분배되어 걸리므로 가용 병렬쿼리의 수가 늘어나 성능이 좋아진다.
2.  안정성 : DB 서버의 일부가 파괴되어도 데이터는 그대로 보존된다.
3.  가용성 : DB 서버의 일부에 장애가 생겨도 남아있는 DB를 이용해 서비스를 계속할 수 있다.

아래 그림은 로드밸런서와 DB 다중화까지 고려한 새로운 설계이다.

![](https://velog.velcdn.com/images/haron/post/7a8a6ffb-f48d-4e4b-936b-016aeea20e00/image.png)

응답시간(latency)는 Cache를 붙이고, 정적콘텐츠를 CDN으로 옮기면 개선할 수 있다.

### 캐시

캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 재요청이 왔을 때 빨리 처리될 수 있도록 하는 저장소다. 캐시는 같은 데이터의 중복 호출에 대한 성능 문제를 완화할 수 있다.

#### 캐시 계층

캐시 계층은 데이터가 잠시 보관되는 곳으로 데이터베이스보다 훨씬 빠르다. 별도의 캐시 계층을 두면 성능이 개선될 뿐 아니라 데이터베이스의 부하를 줄일 수 있고, 캐시 계층의 규모를 독립적으로 확장시키는 것도 가능해진다.

![](https://velog.velcdn.com/images/haron/post/c7afec8b-27e2-462f-bee1-b95951b543be/image.png)

읽기 주도형 캐시 전략 : 요청을 받은 웹 서버는 캐시에 응답이 저장되어 있는지를 본다. 만일 저장되어 있다면 해당 데이터를 클라이언트에 반환한다. 없는 경우에는 데이터베이스 질의를 통해 데이터를 찾아 캐시에 저장한 뒤 클라이언트에 반환한다.

#### 캐시 사용 시 유의할 점

- 캐시는 어떤 상황에 바람직한가
- 어떤 데이터를 캐시에 두어야 하는가?
- 캐시에 보관된 데이터는 어떻게 만료되는가?
- 일광성은 어떻게 유지되는가?
- 장애에는 어떻게 대처할 것인가?
- 캐시 메모리는 얼마나 크게 잡을 것인가?
- 데이터 방출 정책은 무엇인가?

### 콘텐츠 전송 네트워크(CDN)

![](https://velog.velcdn.com/images/haron/post/3b3974d9-aebc-4854-8937-2ff203767532/image.png)
![](https://velog.velcdn.com/images/haron/post/2e6f7313-149e-43b2-9821-c5aaa2818232/image.png)

1. 사용자 A가 이미지 URL을 이용해 image.png에 접근한다.
2. CDN 서버의 캐시에 해당 이미지가 없는 경우 서버는 원본 서버에 요청하여 파일을 가져온다.
3. 원본 서버가 파일을 CDN 서버에 반환한다.
4. CDN 서버는 파일을 캐시하고 사용자 A에게 반환한다.
5. 사용자 B가 같은 이미지에 대한 요청을 CDN 서버에 전송한다.
6. 만료되지 않은 이미지에 대한 요청은 캐시를 통해 처리된다.

#### 고려해야 할 사항

- 바용 : 자주 사용하는 콘텐츠에 대해서만 적용
- 적절한 만료 시한 설정 : 시의성이 중요한 콘텐츠의 경우 만료시점을 잘 정해야 함
- CDN 장애에 대한 대처 방안 : CDN에 장애가 생겼을 경우 애플리케이션의 동작 방식
- 콘텐츠 무효화 방법 : 만료 전 CDN은 CDN 서비스 사업자가 제공하는 API를 통해 무효화 하거나, 콘텐츠의 다른 버전을 서비스하도록 object versioning 이용

![](https://velog.velcdn.com/images/haron/post/57efe42a-9a3f-4180-80b6-fd3c0d09cde0/image.png)

### 무상태 웹 계층

상태 정보를 보관하는 서버는 클라이언트 정보를 유지하여 요청들 사이에 공유되지만 무상태 서버는 이러한 장치가 없다.

![](https://velog.velcdn.com/images/iln1027/post/9f98c7ef-4121-4689-b551-db7c97e8c6d7/image.png)

위 그림에서 사용자 A 는 세션 정보나 프로파일 이미지 정보를 서버 1에 저장하게 되는데 사용자 A 를 인증하기 위해서는 반드시 서버 1로 HTTP 요청이 전달되어야 한다. 이렇게 클라이언트로 부터 같은 서버로 전송 되는 것은 로드밸런서의 고정 세션이라는 기능을 사용하게 되는데, 이는 로드밸런서에 부담을 주고, 로드밸런서 뒷단에 서버를 확장하기 까다로와지고, 장애를 처리하기도 복잡해진다.

#### 무상태 아키텍쳐

![](https://velog.velcdn.com/images/iln1027/post/7db58752-7145-40cb-8da0-f60fe0c58860/image.png)

상태를 저장하지 않는 무상태 아키택처에서는 어떠한 웹 서버로 요청을 전달하여도 사용자의 정보를 알 수 있다.

이는 공유 저장소를 이용하여 테이터를 가져오기 때문인데, 이 공유 저장소는 웹 서버로부터 물리적으로 분리되어 있기 때문에 구조가 단순해지고, 안정적이며, 규모 확장이 쉬워진다.

![](https://velog.velcdn.com/images/iln1027/post/ac80c2bf-359a-4756-897b-806134fc8c88/image.png)

공유저장소는 Memcached/Redis 같은 캐시 또는 NoSQL, RDBMS 를 사용할 수 있다.

### 데이터 센터

데이터 센터를 분리하여 두 개 이상의 데이터 센터에서 서비스를 하는 방식이다. 장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내되는데 이 절차를 지리적 라우팅(geoDNS-routing, geo-routing) 이라고 부른다.

![](https://velog.velcdn.com/images/iln1027/post/a20c98d2-4be4-4024-aead-ec3461c82671/image.png)

위 구성도를 보면 로드 밸런서가 geo-routing 을 통해서 데이터 센터를 선택하여 요청을 하게 된다. 그리고 DC2 Us-West 데이터 센터가 장애가 났다고 가정을 하였을때 geo-routing 은 DC1 US-East 데이터 센터로 트래픽을 전달 100프로 전달 하게 된다.

![](https://velog.velcdn.com/images/iln1027/post/0cbf1617-bd20-4a49-af4e-0264888c9c06/image.png)

### 메시지 큐

메시지의 무손실을 보장하는, 비동기 통신을 지원하는 컴포넌트로 메시지 버퍼 역할을 하며, 비동기적으로 전송한다.

아키텍처는 매우 간단한데 생산자 또는 발행자가 메시지를 만들어 메시지 큐에 발행하면 소비자 혹은 구독자가 메시지 큐로부터 메시지를 받아 그에 맞는 동작을 수행하는 역할을 한다.

![](https://velog.velcdn.com/images/iln1027/post/c59935e4-3d60-4f88-9d83-d2aca26a5510/image.png)

메시지 큐를 이용하면 서비스 또는 서버 간 결합을 느슨하게 가져갈 수 있어 확장성이 보장되어야 하는 애플리케이션을 구성하기 좋다.

생산자와 소비자는 각 상대방의 프로세스가 다운되어 있어도 메시지를 발행 또는 수신 할 수 있다.

### 로그,메트릭 그리고 자동화

소규모 웹 사이트에서는 로그나 메트릭, 자동화는 꼭 필요하지 않다. 하지만 웹 사이트와 함께 사업 규모가 커지면 필수적으로 투자를 해야 한다.

#### 로그

시스템 오류와 문제들을 보다 쉽게 찾아낼 수 있기위해 사용하며, 서버 단위로 모니터링 할 수 있기도 하지만 단일 서비스로 모와주는 (예를 들어 ELK) 도구를 활용하면 더 편리하게 검색하고 조회할 수 있다.

#### 메트릭

메트릭이란 현재 시스템 상태를 파악하기 위한 정보로 아래와 같은 것들이 있다.

- 호스트 단위 메트릭
- 종합 메트릭
- 핵심 비즈니스 메트릭

#### 자동화

생산성을 높이기 위해 자동화 도구를 활용할 수 있다. 지속적 통합을 도와주는 도구(예를 들어 Jenkins)를 활용한다면 개발자가 만드는 코드를 자동으로 검증할 수 있어 문제를 감지하기 쉽다.

또한, 빌드, 테스트 , 배포 등의 절차의 자동화가 가능해 생산성을 향상 시킬 수 있다.

#### 메시지 큐, 로그, 메트릭, 자동화 등을 반영하여 수정한 설계안

![](https://velog.velcdn.com/images/iln1027/post/dff08c78-adc1-40b2-b938-ddb7ee9ee783/image.png)

### 데이터베이스의 규모 확장

#### 수직적 확장

앞에서 설명한 대로 수직 확장은 자원을 증설하는 방법이다. 하지만 단 한대의 마스터 데이터베이스로 처리하게 되는 경우 아래와 같은 약점이 존재한다.

- 자원 증설에 한계가 있어 사용자가 늘어나면 결국 감당하기 어렵게 된다.
- 단일 장애 지점으로 인한 위험성이 크다.
- 고성능 서버로 올라갈 수 록 가격이 올라 비용이 많이 든다.

#### 수평적 확장

데이터베이스의 수평적 확장은 샤딩이라고도 부르는데, 더 많은 서버를 추가함으로써 성능을 향상 시킬 수 있다.

샤딩은 샤드라고 부르는 작은 단위로 분할하는 기술로, 같은 스키마를 사용하지만 샤드에 보관되는 데이터 사이에는 중복이 없다.

![](https://velog.velcdn.com/images/iln1027/post/3593052b-9b7d-4e8b-9c83-53ad291b4b4d/image.png)

#### 샤딩 전략 구현시 고려사항

가장 중요한 것은 샤딩키를 어떻게 정하느냐 하는 것이다. 파티션 키라고도 부르며, 데이터가 어떻게 분산될지 정하는 하나 이상의 칼럼으로 구성된다.

위 그림에서 샤딩키는 user_id 이다.

샤딩은 데이터베이스 규모 확장을 실현하는 좋은 기술이지만 완벽하지는 않기 때문에 아래와 같은 문제가 발생 할 수 있다.

- 데이터의 재 샤딩 : 데이터가 너무 많아지거나, 샤드간 데이터 분포가 균등하지 못할때는 재 샤딩이 필요하다. 샤드 소진이라고 불리는 이런 현상은 안정 해시 기법을 활용하여 해결할 수 있다.
- 유명인사 문제 : 핫스팟 키 문제라고 부르는 특정 샤드에 질의가 집중되어 서버가 과부하 걸리는 문제가 있다.
- 조인과 비정규화 : 샤딩을 하면 join 이 힘들어 진다. 이를 해결하기 위해 비정규화를 하여 하나의 테이블에서 질의가 수행될 수 있도록 해야 한다.

![](https://velog.velcdn.com/images/iln1027/post/4ae24928-5fa7-42c6-ae80-7d62649a989b/image.png)

#### 이번장에서 시스템 규모 확장을 위해 살펴본 기법들

- 웹 계층은 무상태 계층
- 모든 계층에 다중화 도입
- 가능한 많은 데이터를 캐시할 것
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것

---

### 질문

- DNS, 로드밸런서의 역할?
- 캐시를 효율적으로 사용하는 방법?
