# 질문
1. p8 데이터베이스 다중화
  데이터베이스를 나누는 경우 실시간 업데이트에 대해서 지연시간이 발생하지 않는가? 
2. p25 메시지큐
  메시지큐를 받는 서버에 일시적 장애가 생겨 이미 수신한 메시지를 정상적으러처리하지 못한 경우 이 요청은 어떻게 되는가 ?
3. 샤딩에서 핫스팟 키를 해결하기 위한 방법은?




# 1. 사용자 수에 따른 규모 확장성

## 1.1 데이터베이스

### 비관계형 데이터베이스가 필요한 환경
- 아주 낮은 응답시간(latency) 필요
- 비정형 데이터
- 데이터(JSON, YAML, XML 등)를 직렬화(serialize)하거나 역직렬화(deserialize)만 수행
- 아주 대량의 데이터를 저장

## 1.2 수직적 규모확장 vs 수평적 규모확장

### 개념적 정의
- 수직적 규모확장(vertical scaling)
  - 스케일 업(scale up). 기능의 향상에 초첨을 둠
  - 서버에 고사양 자원(더 좋은 CPU, 더 많은 RAM 등)을 추가하는 행위


- 수평적 규모확장(horizontal scaling)
  - 스케일 아웃(scale out). 규모의 확장에 초첨을 둠
  - 더 많은 서버를 추가하여 성능을 개선


### 수직적 확장의 단점
  - 한 대의 서버의 기능을 향상시키는 데에는 한계가 존재함
  - 장애에 대한 자동복구(failover)와 다중화(redundacy)에 취약함
  - 한 대의 서버가 중단될 경우 모든 서비스가 중지됨


따라서 댜규모 어플리케이션을 지원하는 서버는 수직적 확장보다 수평적 확장이 적절하다.
## 1.3 수평적을 확장을 위한 기술 
### 로드밸런서(load balancer)
트래픽을 분산하는 역할을 수행
웹계층(서버-클라이언트)간의 부하만 해결됨

### 데이터베이스 다중화
master-slave 관계를 설정 후 원본은 master, 사본은 slave에 저장하는 방식
쓰기 연산(write operation)은 master에서만 수행(insert, update, delete)
slave는 사본을 전달 받으며, 읽기 연산(read operation)만 수행

### 캐시서버

### CDN(컨텐츠 전송 네트워크)
정적 데이터를 호출 시 물리적으로 가까운 곳에 있는 서버에서 데이터를 가져오는 방식
  
### 무상태(stateless) 웹계층
사용자 상태 정보(ex. 세션정보)를 웹 계층에서 제거
일반적으로 데이터베이스에 저장
이런 경우 로드벨런서가 동일한 세션에 대해 같은 서버로 처리하기 위해서 고정세션(sticky session)을 사용함

### 데이터센터
물리적으로 가까운 데이터센터에서 요청을 처리

### 메시지큐
메시지의 무손시을 보장하는 비동기 통신을 지원하는 컴포넌트
시간이 오래 걸리거나, 비동기적으로 처리해도 좋은 요청들을 메시지큐에 담아 요청함
이런 경우 생산자와 소비자 서비스의 규모를 독립적으로 확장 가능하다


### 로그, 메트릭, 자동화

## 1.4 데이터베이스 확장
### 수형적 확장(sharding)
대규모 데이터베이스를 작은 단위로 분할하는 기술
예를들어 사용자ID 를 홀, 짝으로 분할하여 저장하면 DB의 크기가 절반으로 줄어드는 효과가 있음

#### 재샤딩
한 번 샤딩된 DB를 다시 샤딩하기도 한다. 샤드간 데이터 분포가 균등하지 못한 경우 수행 


#### hotspot key(celebrity)
특정 샤드에 질의가 집중되어 생기는 문제

#### 조인, 비정규화


## 1.5 정리
시스템 규모 확장을 위해서는 아래 내용을 지켜야 한다.
- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 많은 데이터를 캐싱
- 여러 데이터 센터 지원
- 정적 콘텐츠는 CDN을 통해 서비스
- 데이터 계층은 샤딩을 통해 규모 확장할 것
- 각 계층은 독립적 서비스로 분할
- 시스템을 지속적으로 모니터링하고, 자동화 도구를 활용






